<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.web.dao.prescriptionDao">
  <resultMap id="resultPrescription" type="Prescription">
    <id column="presid" property="presid" />
    <result column="mediid" property="mediid" />
    <result column="medinum" property="medinum" />
    <result column="presdocaid" property="presdocaid" />
    <result column="isdelete" property="isdelete" />
    <association property="doctoradvice" javaType="Doctoradvice">
         <id column="docaid" property="docaid"/>
         <result column="patid" property="patid"/>
         <result column="docaempdocid" property="docaempdocid"/>
    </association>
    <association property="medicine" javaType="Medicine">
         <id column="mediid" property="mediid"/>
         <result column="mediname" property="mediname"/>
    </association>
    
  </resultMap>
  <select id="query" resultMap="resultPrescription">
           SELECT presid,p.mediid,mediname,medinum,presdocaid
           from doctoradvice d,prescription p,medicine m
           where m.mediid=p.mediid and presdocaid=docaid
  </select>
  
  <sql id="PrescriptionCondition">
    <where>
      p.isdelete!=0
      <if test="presid != null">
      	and presid=#{presid}
      </if>
      <if test="mediid != null">
      	and p.mediid=#{mediid}
      </if>
      
      <if test="mediname != null and mediname !=''">
      	and m.mediname like concat('%',concat(#{mediname},'%'))
      </if>
      
      <if test="presdocaid != null">
      	and presdocaid=#{presdocaid}
      </if>
      and m.mediid=p.mediid and presdocaid=docaid
    </where>
  </sql>
  
  <select id="queryByCondition" resultMap="resultPrescription" parameterType="map">
           select presid,p.mediid,mediname,medinum,presdocaid
           from doctoradvice d,prescription p,medicine m
		   <include refid="PrescriptionCondition"/>
  </select>
  
  <!-- 根据处方单id查询对象 -->
  <select id="findByPresId" parameterType="Integer" resultMap="resultPrescription">
       select presid,p.mediid,mediname,medinum,presdocaid
           from doctoradvice d,prescription p,medicine m
           where presid=#{presid} and m.mediid=p.mediid and presdocaid=docaid
  </select>
  
  <delete id="delete" parameterType="Integer">
    update prescription set isdelete=0 where presid=#{presid}
  </delete>
  
  <insert id="add" parameterType="Prescription">
    insert into prescription (mediid,medinum,presdocaid,isdelete)
    values (#{mediid},#{medinum},#{presdocaid},1)
    <!-- 自动增长后的主键   -->
    <selectKey keyColumn="presid" keyProperty="presid" resultType="int">
    	SELECT LAST_INSERT_id()
    </selectKey>
  </insert>

  <update id="update" parameterType="Prescription">
    update prescription
    <set>
        mediid = #{mediid},
        medinum = #{medinum},
        presdocaid = #{presdocaid}
    </set>
      where presid=#{presid}
  </update>
  
</mapper>